<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Altaris — Deal Pipeline</title>
  <style>
    :root { --bg:#1b1b1b; --fg:#f0f0f0; --panel:#2a2a2a; --line:#333; --card:#1f1f1f; --accent:#4ea3ff; }
    *{box-sizing:border-box}
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--fg); }
    header { padding: 14px 16px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; background: #222; position: sticky; top:0; z-index: 5; }
    .actions { display:flex; gap:8px; align-items:center; }
    button { background: var(--accent); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; }
    button:hover { filter: brightness(0.9); }
    .ghost-btn { background:#3b3b3b; border:1px solid #555; color:#fff; }
    .wrap { padding: 12px 16px; }
    .stats, .charts { display: flex; gap: 16px; flex-wrap: wrap; padding: 12px 0; }
    .stat { padding: 10px; border: 1px solid var(--line); border-radius: 8px; min-width: 140px; background: var(--panel); cursor:pointer; }
    .stat .label { font-size: 12px; opacity: .7; }
    .stat .value { font-size: 22px; font-weight: 700; }
    .stat.active { outline:2px solid var(--accent); box-shadow:0 0 0 2px #4ea3ff33 inset; }
    .stat[role="button"] { outline-offset: 2px; }

    .board { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; padding-bottom: 24px; margin-top: 12px; }
    .col { border: 1px solid var(--line); border-radius: 8px; padding: 8px; background: var(--panel); min-height: 200px; }
    .col b { text-transform: capitalize; font-size: 14px; }
    .card { margin-top: 8px; padding: 8px; border: 1px solid #444; border-radius: 6px; background: var(--card); position:relative; }
    .card-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }
    .row label { font-size: 12px; display: flex; gap: 6px; align-items: center; }
    .row input, .row select { width: 100%; background: #333; color: white; border: 1px solid #555; border-radius: 4px; padding: 4px; }
    .buttons { display: flex; gap: 8px; margin-top: 6px; flex-wrap: wrap; }
    .topform { display:flex; gap:8px; flex-wrap:wrap; align-items:center; padding: 12px 16px; }
    .topform input, .topform select { background:#333; color:#fff; border:1px solid #555; border-radius:4px; padding:6px; }
    canvas { background: var(--panel); border-radius: 8px; padding: 8px; }

    .funds { margin-top:8px; padding-top:8px; border-top:1px dashed #444; }
    .fund-row { display:flex; gap:8px; align-items:center; font-size: 13px; flex-wrap: wrap; }

    .chip { background:#333; border:1px solid #555; border-radius:999px; padding:2px 8px; }
    .chip-btn { background:#333; border:1px solid #555; color:#fff; border-radius:999px; padding:6px 12px; cursor:pointer; }
    .chip-btn:hover { border-color:#6b7280; filter:none; }
    .light { opacity:.75; }

    .drop { border:2px dashed #555; border-radius:8px; padding:12px; text-align:center; margin-left: 12px; color:#bbb; }
    .drop.drag { border-color:#4ea3ff; color:#fff; }
    .err { color:#ff7b7b; font-size:12px; }
    .ok { color:#9acd32; font-size:12px; }

    #filtersToolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom: 8px; }
    #searchBox { background:#333; color:#fff; border:1px solid #555; border-radius:4px; padding:6px; }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; }
    .modal.open { display:flex; }
    .modal-card { background:#2a2a2a; color:#f0f0f0; padding:20px; border-radius:8px; width:min(640px, 92vw); max-height:80vh; overflow:auto; box-shadow:0 12px 40px rgba(0,0,0,0.6); }
    .modal-card h3 { margin:0 0 8px 0; }
    .modal-footer { display:flex; gap:8px; margin-top:12px; }
    .modal-footer button { background:#3b83f6; }
    .list-row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px solid #3a3a3a; }
    .list-row .meta { font-size:12px; color:#bbb; }

    .clip-btn { width:34px; height:34px; border-radius:8px; padding:0; display:inline-flex; align-items:center; justify-content:center;
                background:#25272c; border:1px solid #5a5f69; position:relative; }
    .clip-btn:hover { border-color:var(--accent); box-shadow:0 0 0 2px #4ea3ff33 inset; }
    .clip-svg { width:18px; height:18px; stroke:#e5e7eb; fill:none; stroke-width:1.8; display:block; }
    .clip-badge { position:absolute; top:-6px; right:-6px; min-width:18px; height:18px; padding:0 5px;
                  background:var(--accent); color:#0b1220; border:2px solid #1f2937; border-radius:999px;
                  font-size:11px; font-weight:700; line-height:14px; display:none; align-items:center; justify-content:center; }
      /* Tighter font and inputs inside Kanban cards */
.board .card {
  font-size: 13px;   /* default text smaller */
}
.board .card input,
.board .card select,
.board .card button {
  font-size: 12px;   /* controls smaller */
  padding: 3px 6px;  /* tighter padding */
}
.board .card .buttons button {
  font-size: 12px;
  padding: 4px 8px;
}

  </style>
  <style>
    .userbar{display:flex;gap:8px;align-items:center;margin-left:12px}
    #whoami{opacity:.75;font-size:12px}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
 
  <script>
      window.DOCS_CHAT_CONFIG = {
        endpoint: "https://volftexuyqyykrnewewa.supabase.co/functions/v1/doc-search",
        topK: 5,
        viewerCandidates: [
          "https://unpkg.com/pdfjs-dist@3.11.174/web/viewer.html",
          "https://mozilla.github.io/pdf.js/web/viewer.html"
        ]
      };
  </script>

<style id="kanban-v8-styles">
  :root { --panel:#151515; --line:#2a2a2a; --fg:#e6e6e6; --muted:#a0aec0; --accent:#2b6cb0; --good:#38a169; }
  /* Board & columns */
  .board { display:grid; grid-auto-flow:column; gap:16px; align-items:start; padding:8px 8px 24px; overflow-x:auto; }
  .board .col { min-width:340px; max-width:420px; display:flex; flex-direction:column; gap:10px;
    transition: width .2s ease, min-width .2s ease, max-width .2s ease; }
  /* Collapsed columns = slim rail */
  .board .col.collapsed { width:56px !important; min-width:56px !important; max-width:56px !important; }
  .board .col.collapsed > *:not(.col-head) { display:none !important; }
  /* Sticky column header */
  .col .col-head {
    position:sticky; top:0; z-index:2;
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; column-gap:10px;
    background:var(--panel); border:1px solid var(--line); border-bottom:0;
    padding:10px 10px; border-radius:10px 10px 0 0;
    backdrop-filter:saturate(110%) blur(6px);
  }
  .col .col-head .title { font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing:.04em; color:var(--fg); }
  .col .col-head .stats { display:inline-flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .col .col-head .stat {
    display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px;
    background:#1a2433; color:#e6f0ff; border:1px solid #2f4b7c; font-size:12px;
  }
  .col .col-head .stat .num { font-weight:800; font-size:13px; }
  .col .col-head .stat.money { background:#182a1d; color:#eaffea; border-color:#2d5a37; }
  .col .col-head .stat.money .num { color:#9ef0b8; }
  .col .col-head .stat.deals .num { color:#b6d0ff; }
  .col .col-head .collapse-btn {
    width:26px; height:26px; border-radius:8px; border:1px solid var(--line);
    background:#1c1c1c; color:#ddd; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
    transition: transform .15s ease, background .15s ease;
  }
  .col .col-head .collapse-btn:hover { background:#232323; }
  .col .col-head .collapse-btn:before { content:"›"; font-size:14px; display:inline-block; }
  .col.collapsed .col-head { grid-template-columns:1fr; justify-items:center; padding:12px 4px; }
  .col.collapsed .col-head .stats { display:none; }
  .col.collapsed .col-head .title { writing-mode:vertical-rl; transform:rotate(180deg); text-align:center; font-size:12px; opacity:.9; }
  .col.collapsed .col-head .collapse-btn { transform:rotate(180deg); }
  /* Cards */
  .col .card { border-radius:12px; }
  /* Collapsed tiles (cards) */
  .card.is-collapsed { padding:8px !important; }
  .card.is-collapsed > :not(.card-summary) { display:none !important; }
  .card .card-summary { display:flex; align-items:center; gap:8px; margin:2px 0 0; }
  .card .card-summary .ttl { font-weight:600; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  /* Quick icon controls above board (left) */
  .kanban-quick-controls{ display:flex; gap:8px; align-items:center; margin:8px 0 8px 8px; }
  .kanban-quick-controls .icon-btn{
    width:28px; height:28px; border-radius:8px; border:1px solid var(--line);
    background:#1c1c1c; color:#e6e6e6; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;
  }
  .kanban-quick-controls .icon-btn:hover{ background:#232323; }
  .kanban-quick-controls .sep{ width:8px; height:1px; background:transparent; }
</style>
</head>
<body>
  <header>
    <div>
      <div style="font-size:20px; font-weight:700;">Altaris — Deal Pipeline</div>
      <div style="font-size:12px; opacity:.7;">interactive sector donut • ordered palettes • clickable legends</div>
    </div>
    <div class="actions">
      <input type="file" id="file" accept=".csv" style="display:none" />
      <button id="importBtn">⬆ Import CSV</button>
      <div id="drop" class="drop">or drag a CSV here</div>
      <button id="export">⬇ Export CSVs</button>
        <div class="userbar">
      <span id="whoami" class="light"></span>
      <button id="logoutBtn" class="ghost-btn" title="Sign out" onclick="window.altarisLogout && window.altarisLogout()">Logout</button>
    </div>
  </header>

  <div class="topform">
    <input id="name" placeholder="Deal name" />
    <input id="source" placeholder="Source company" />
    <select id="type">
      <option>DirectLending</option>
      <option>Secondary</option>
      <option>CoInvest</option>
      <option>RealEstate</option>
    </select>
    <input id="currency" placeholder="Currency" value="USD" />
    <input id="size" type="number" step="0.01" placeholder="Size (M)" style="width:120px;" />
    <input id="sector" placeholder="Sector" />
    <button id="add">+ Add deal</button>
  </div>

  <div class="wrap">
    <div id="importStatus" class="light"></div>

    <section class="stats" id="stats"></section>

    <section class="charts">
      <canvas id="chartType" width="380" height="240"></canvas>
      <canvas id="chartSector" width="380" height="240"></canvas>
    </section>

    <div id="filtersToolbar">
      <div id="filterBar" class="fund-row" style="gap:8px;"></div>
      <input id="searchBox" placeholder="Search deals…" />
      <button id="clearSearch" class="chip-btn">Clear search</button>
      <button id="clearAllFiltersBtn" class="chip-btn">Clear all</button>
    </div>

    <section class="board" id="board"></section>
  </div>

  <!-- Attachments modal -->
  <div id="attachmentModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="attachTitle">
      <h3 id="attachTitle">Attachments</h3>
      <div id="attachmentList" class="light">Loading…</div>
      <div class="modal-footer">
        <input type="file" id="attachFileInput" style="display:none;" multiple />
        <button id="attachUploadBtn">Upload</button>
        <button id="attachRefreshBtn" class="ghost-btn">Refresh</button>
        <button id="attachCloseBtn" class="ghost-btn" style="margin-left:auto;">Close</button>
      </div>
    </div>
  </div>
<!-- Edit Deal modal -->
<div id="editDealModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="editDealTitle">
    <h3 id="editDealTitle">Edit Deal</h3>
    <div class="light" style="margin-bottom:10px;">Update the details and save</div>

    <input type="hidden" id="edit-id" />

    <div class="row">
      <label>Name
        <input id="edit-name" />
      </label>
      <label>Stage
        <select id="edit-stage"></select>
      </label>
    </div>

    <div class="row">
      <label>Type
        <input id="edit-type" />
      </label>
      <label>Source
        <input id="edit-source" />
      </label>
    </div>

    <div class="row">
      <label>Currency
        <input id="edit-currency" />
      </label>
      <label>Size (M)
        <input type="number" step="0.01" id="edit-size" />
      </label>
    </div>

    <div class="row">
      <label>Sector
        <input id="edit-sector" />
      </label>
    </div>

    <div class="modal-footer">
      <button id="editCancelBtn" class="ghost-btn">Cancel</button>
      <button id="editSaveBtn">Save</button>
    </div>
  </div>
</div>

  <script src="/js/doc-ingest-client.js" defer></script>
  <!-- Load chat.js explicitly so window.openDocChat is available -->
  <script src="./chat.js" defer></script>
  <script src="./js/chat-launcher.js" defer></script>
  <script src="./js/viewer-fallback.js"></script>
  <script src="./app.js"></script>
<script id="kanban-v8-scripts">
(function(){
  // Helpers
  const $  = (s, el=document)=> el.querySelector(s);
  const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
  const throttle = (fn, wait=50)=>{ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };

  // Currency normalization
  const DEFAULT_RATES = { USD:1, EUR:1.09, GBP:1.27 };
  const getRates = ()=> Object.assign({}, DEFAULT_RATES, (window.KANBAN_CURRENCY_RATES||{}));
  const unitMultiplier = (u)=>{
    if(!u) return 1; const v=String(u).toLowerCase();
    if(v==='k') return 1e3; if(v==='m'||v==='mm'||v==='mn') return 1e6; if(v==='b'||v==='bn') return 1e9; return 1;
  };
  const detectCcy = (tok)=>{
    if(!tok) return 'USD'; tok=String(tok).trim();
    if(tok==='€') return 'EUR'; if(tok==='£') return 'GBP'; if(tok==='$') return 'USD';
    tok=tok.toUpperCase(); if(['USD','EUR','GBP'].includes(tok)) return tok; return 'USD';
  };
  const parseAmountAndCurrency = (text)=>{
    if(!text) return {amt:0, ccy:'USD'};
    const s = String(text).replace(/\s+/g,' ').trim();
    // 1) Total Committed: [USD|EUR|GBP|$|€|£]? N.N [k|m|b|mm|mn|bn]
    let m = s.match(/Total\s*Committed[^\d$€£A-Z]*([$€£]|USD|EUR|GBP)?\s*([\d.,]+)\s*([KkMmBb](?:[NnMm])?)/i);
    if(m){ const c=detectCcy(m[1]||'USD'); const n=parseFloat((m[2]||'0').replace(/,/g,''))||0; const mult=unitMultiplier(m[3]); return {amt:n*mult, ccy:c}; }
    // 2) Any currency token + number + unit
    m = s.match(/(USD|EUR|GBP|[$€£])\s*([\d.,]+)\s*([KkMmBb](?:[NnMm])?)/i);
    if(m){ const c=detectCcy(m[1]); const n=parseFloat((m[2]||'0').replace(/,/g,''))||0; const mult=unitMultiplier(m[3]); return {amt:n*mult, ccy:c}; }
    return {amt:0, ccy:'USD'};
  };
  const toUSD = (amt, ccy, rates)=> (rates[ccy]||1)*amt;
  const formatShortUSD = (n)=> n>=1e12? '$'+(n/1e12).toFixed(2).replace(/\.0+$/,'')+'T'
    : n>=1e9 ? '$'+(n/1e9 ).toFixed(2).replace(/\.0+$/,'')+'B'
    : n>=1e6 ? '$'+(n/1e6 ).toFixed(2).replace(/\.0+$/,'')+'M'
    : n>=1e3 ? '$'+(n/1e3 ).toFixed(2).replace(/\.0+$/,'')+'K'
    : '$'+Math.round(n);

  // Commitment detection per card
  const commitmentFromCard = (card)=>{
    const dataAttr = (card.getAttribute('data-committed') || card.dataset?.committed || '').trim();
    if (dataAttr) return parseAmountAndCurrency(dataAttr);
    const node = $$( '*', card ).find(n => /Total\s*Committed/i.test(n.textContent||''));
    if (node) return parseAmountAndCurrency(node.textContent||'');
    return parseAmountAndCurrency(card.textContent||'');
  };

  // Column header creation / refresh
  const ensureColHead = (col)=>{
    let head = $('.col-head', col);
    if (head) return head;
    head = document.createElement('div'); head.className='col-head';
    const title = document.createElement('div'); title.className='title';
    const stats = document.createElement('div'); stats.className='stats';
    const deals = document.createElement('div'); deals.className='stat deals'; deals.innerHTML='<span class="num">0</span> deals';
    const money = document.createElement('div'); money.className='stat money'; money.innerHTML='<span class="num">—</span> total';
    const btn = document.createElement('button'); btn.className='collapse-btn'; btn.title='Collapse';
    stats.appendChild(deals); stats.appendChild(money);
    head.appendChild(title); head.appendChild(stats); head.appendChild(btn);
    const label = col.querySelector('b, .col-title, h3');
    const t = (label?label.textContent:col.getAttribute('data-title')||'').trim() || 'Column';
    title.textContent = t;
    if (label && label.parentNode===col){ col.insertBefore(head, label); label.remove(); } else { col.insertBefore(head, col.firstChild); }
    const setCollapsed = (on)=>{
      col.classList.toggle('collapsed', !!on);
      btn.setAttribute('aria-expanded', (!on).toString());
      try{ const store=JSON.parse(localStorage.getItem('kanbanCollapsed')||'{}'); store[t]=!!on; localStorage.setItem('kanbanCollapsed', JSON.stringify(store)); }catch{}
    };
    btn.addEventListener('click', ()=> setCollapsed(!col.classList.contains('collapsed')));
    head.addEventListener('dblclick', ()=> setCollapsed(!col.classList.contains('collapsed')));
    try{ const store=JSON.parse(localStorage.getItem('kanbanCollapsed')||'{}'); if(store[t]) setCollapsed(true); }catch{}
    return head;
  };
  const refreshCol = (col)=>{
    const head = ensureColHead(col);
    const cards = $$('.card', col);
    const count = cards.length;
    const rates = getRates();
    let sumUSD = 0; cards.forEach(c=>{ const {amt, ccy} = commitmentFromCard(c); sumUSD += toUSD(amt, ccy, rates); });
    const dealsNum = $('.stat.deals .num', head); if (dealsNum) dealsNum.textContent = String(count);
    const moneyNum = $('.stat.money .num', head); if (moneyNum) moneyNum.textContent = sumUSD>0 ? ('≈'+formatShortUSD(sumUSD)) : '—';
  };
  const refreshAll = ()=>{ const board = $('.board') || $('#board'); if(!board) return; $$('.col', board).forEach(refreshCol); };

  // Tiles collapse
  const getDealTitle = (card)=>{
    const sel = card.querySelector('[data-deal-name], .deal-title, .card-title, .title h4, h4.title, h3.title, h4, h3, b, strong');
    if (sel && sel.textContent) return sel.textContent.trim();
    const txt = (card.textContent||'').split('\n').map(s=>s.trim()).filter(Boolean)[0] || 'Deal';
    return txt.slice(0,80);
  };
  const ensureCardSummary = (card)=>{
    let sum = $('.card-summary', card);
    if (!sum){ sum = document.createElement('div'); sum.className='card-summary'; card.insertBefore(sum, card.firstChild); }
    let ttl = $('.ttl', sum); if(!ttl){ ttl = document.createElement('div'); ttl.className='ttl'; sum.appendChild(ttl); }
    ttl.textContent = getDealTitle(card);
    return sum;
  };
  const collapseTilesAll = ()=>{
    $$('.board .col .card').forEach(card => { ensureCardSummary(card); card.classList.add('is-collapsed'); });
    try{ localStorage.setItem('kanbanTilesCollapsed','1'); }catch{}
    refreshAll();
  };
  const expandTilesAll = ()=>{
    $$('.board .col .card').forEach(card => { card.classList.remove('is-collapsed'); const s=$('.card-summary', card); if(s) s.remove(); });
    try{ localStorage.setItem('kanbanTilesCollapsed','0'); }catch{}
    refreshAll();
  };

  // Quick controls (icons) above board
  const mountControls = ()=>{
    const board = $('.board, #board'); if(!board) return;
    // Remove any legacy toolbar
    $$('.kanban-toolbar').forEach(n=>n.remove());
    // Prevent duplicates
    if (board.previousElementSibling && board.previousElementSibling.classList && board.previousElementSibling.classList.contains('kanban-quick-controls')) return;
    const bar = document.createElement('div'); bar.className='kanban-quick-controls';
    const btnColCollapse = document.createElement('button'); btnColCollapse.className='icon-btn'; btnColCollapse.title='Collapse columns'; btnColCollapse.textContent='≪';
    const btnColExpand   = document.createElement('button'); btnColExpand.className='icon-btn'; btnColExpand.title='Expand columns';   btnColExpand.textContent='≫';
    const spacer         = document.createElement('span');   spacer.className='sep';
    const btnTileCollapse= document.createElement('button'); btnTileCollapse.className='icon-btn'; btnTileCollapse.title='Collapse tiles';  btnTileCollapse.textContent='▥';
    const btnTileExpand  = document.createElement('button'); btnTileExpand.className='icon-btn'; btnTileExpand.title='Expand tiles';    btnTileExpand.textContent='▤';
    btnColCollapse.onclick = ()=>{ $$('.board .col').forEach(col=>{ col.classList.add('collapsed'); }); try{ const store={}; $$('.board .col .col-head .title').forEach(t=>store[t.textContent]=true); localStorage.setItem('kanbanCollapsed', JSON.stringify(store)); }catch{} };
    btnColExpand.onclick   = ()=>{ $$('.board .col').forEach(col=>{ col.classList.remove('collapsed'); }); try{ const store={}; $$('.board .col .col-head .title').forEach(t=>store[t.textContent]=false); localStorage.setItem('kanbanCollapsed', JSON.stringify(store)); }catch{} };
    btnTileCollapse.onclick= collapseTilesAll;
    btnTileExpand.onclick  = expandTilesAll;
    bar.appendChild(btnColCollapse); bar.appendChild(btnColExpand); bar.appendChild(spacer); bar.appendChild(btnTileCollapse); bar.appendChild(btnTileExpand);
    board.parentNode.insertBefore(bar, board);
    // Restore tiles state
    try{ if (localStorage.getItem('kanbanTilesCollapsed')==='1') collapseTilesAll(); }catch{}
  };

  // Public API (optional)
  window.KANBAN_STATS = { refreshAll, parseAmountAndCurrency, commitmentFromCard, getRates };

  // Enhance on load + observe for dynamic renders
  document.addEventListener('DOMContentLoaded', ()=>{
    const board = document.querySelector('.board, #board');
    if (!board) return;
    // Initial pass
    refreshAll(); mountControls();
    // Mutation observer to keep stats fresh and ensure headers exist
    const obs = new MutationObserver(throttle(()=>{ $$('.col', board).forEach(ensureColHead); refreshAll(); }, 50));
    obs.observe(board, { childList:true, subtree:true });
    // Safety net
    window.addEventListener('load', ()=>{ $$('.col', board).forEach(ensureColHead); refreshAll(); });
  });
})();
</script>
</body>
</html>
