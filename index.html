<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Altaris — Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <style>
    body { margin:0; display:flex; align-items:center; justify-content:center; min-height:100vh; background:#0f172a; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:#e5e7eb; }
    .card { background:#111827; padding:22px; border-radius:12px; width:min(380px,92vw); box-shadow:0 6px 22px rgba(0,0,0,.45); border:1px solid #1f2937; }
    h1 { margin:0 0 6px; font-size:20px; }
    .sub { font-size:12px; color:#94a3b8; margin-bottom:10px; }
    label { display:block; margin-top:12px; font-size:13px; }
    input { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; }
    button { width:100%; margin-top:14px; padding:10px; border:none; border-radius:8px; cursor:pointer; font-weight:700; }
    .primary { background:#4ea3ff; color:#0b1220; }
    .ghost { background:#1f2937; color:#e5e7eb; border:1px solid #374151; }
    .row { display:flex; gap:10px; }
    .msg { min-height:20px; font-size:12px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Sign in to Altaris</h1>
    <div id="note" class="sub">Use your invite email and password to sign in.</div>

    <!-- Sign-in panel -->
    <div id="signinPanel">
      <label>Email</label>
      <input id="email" type="email" autocomplete="username" placeholder="name@company.com" />
      <label>Password</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="Password" />
      <button class="primary" id="loginBtn">Login</button>
      <div class="row">
        <button class="ghost" id="resetBtn">Forgot password</button>
        <button class="ghost" id="logoutBtn">Sign out</button>
      </div>
      <div id="message" class="msg"></div>
    </div>

    <!-- Password recovery panel -->
    <div id="recoveryPanel" style="display:none;">
      <div class="sub">Set a new password for <span id="recoveryEmail"></span>.</div>
      <label>New password</label>
      <input id="newPass" type="password" placeholder="New password" />
      <label>Confirm new password</label>
      <input id="newPass2" type="password" placeholder="Confirm new password" />
      <button class="primary" id="setPassBtn">Set new password</button>
      <div id="recoveryMsg" class="msg"></div>
    </div>
  </div>

<script>
const sb = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
const qs = (id)=>document.getElementById(id);
const show = (el, vis)=> el.style.display = vis ? '' : 'none';

async function showSigninOrRecovery(initial=false){
  // Check for recovery via URL or auth event-created session
  const urlHasRecovery = location.hash.includes('type=recovery');
  const { data: { session } } = await sb.auth.getSession();

  if (urlHasRecovery) {
    // Ensure we have the latest session (Supabase sets a temporary recovery session)
    // If you ever switch to "code" flow, you may need exchangeCodeForSession().
  }

  const userEmail = session?.user?.email || '';
  if (urlHasRecovery || (session && session.user && initial===false)) {
    // Recovery mode
    qs('note').textContent = 'Password recovery — set a new password.';
    qs('recoveryEmail').textContent = userEmail || '(your account)';
    show(qs('signinPanel'), false);
    show(qs('recoveryPanel'), true);
  } else {
    // Normal sign-in
    qs('note').textContent = 'Use your invite email and password to sign in.';
    show(qs('recoveryPanel'), false);
    show(qs('signinPanel'), true);
  }
}

// Listen for Supabase auth state changes (this fires with PASSWORD_RECOVERY on reset link)
sb.auth.onAuthStateChange((event, session) => {
  if (event === 'PASSWORD_RECOVERY') {
    qs('note').textContent = 'Password recovery — set a new password.';
    qs('recoveryEmail').textContent = session?.user?.email || '';
    show(qs('signinPanel'), false);
    show(qs('recoveryPanel'), true);
  }
});

// Initial render
showSigninOrRecovery(true);

// Buttons
qs('loginBtn').onclick = async ()=>{
  const email = qs('email').value.trim();
  const password = qs('password').value;
  const { error } = await sb.auth.signInWithPassword({ email, password });
  qs('message').textContent = error ? error.message : '';
  if (!error) window.location.href = 'home.html';
};

qs('resetBtn').onclick = async ()=>{
  const email = qs('email').value.trim();
  if (!email) { qs('message').textContent = 'Enter your email above first.'; return; }
  const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/index.html' });
  qs('message').textContent = error ? error.message : 'Password reset email sent.';
};

qs('logoutBtn').onclick = async ()=>{
  await sb.auth.signOut();
  localStorage.clear(); sessionStorage.clear();
  qs('message').textContent = 'Signed out. You can now log in.';
};

qs('setPassBtn').onclick = async ()=>{
  const p1 = qs('newPass').value;
  const p2 = qs('newPass2').value;
  const msg = qs('recoveryMsg');
  if (!p1 || p1.length < 6) { msg.textContent = 'Password must be at least 6 characters.'; return; }
  if (p1 !== p2) { msg.textContent = 'Passwords do not match.'; return; }
  const { error } = await sb.auth.updateUser({ password: p1 });
  if (error) { msg.textContent = error.message; return; }
  msg.textContent = 'Password updated. Redirecting…';
  setTimeout(()=> window.location.href = 'index.html', 800);
};
</script>
</body>
</html>
